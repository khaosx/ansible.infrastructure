---
- name: Deploy and manage Paperless stack
  block:
    - name: Preflight | Ensure Docker Engine is installed
      ansible.builtin.command:
        cmd: docker --version
      register: paperless_stack_docker_version
      changed_when: false

    - name: Preflight | Ensure Docker Compose plugin is installed
      ansible.builtin.command:
        cmd: docker compose version
      register: paperless_stack_compose_version
      changed_when: false

    - name: Assert required Paperless secrets are provided
      ansible.builtin.assert:
        that:
          - paperless_stack_db_password | length > 0
          - paperless_stack_secret_key | length > 0
          - paperless_stack_admin_user | length > 0
          - paperless_stack_admin_password | length > 0
        fail_msg: >-
          Provide paperless_stack_db_password, paperless_stack_secret_key,
          paperless_stack_admin_user, and paperless_stack_admin_password via inventory/vault.

    - name: Ensure Paperless stack directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop: "{{ paperless_stack_dirs }}"

    - name: Render core Paperless environment files
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ paperless_stack_dir }}/{{ item.dest }}"
        owner: root
        group: root
        mode: "0640"
      loop:
        - { src: "paperless.env.j2", dest: "paperless/.env" }
        - { src: "postgres.env.j2", dest: "postgres/.env" }
        - { src: "redis.env.j2", dest: "redis/.env" }
        - { src: "gotenberg.env.j2", dest: "gotenberg.env" }
        - { src: "tika.env.j2", dest: "tika.env" }
      no_log: true

    - name: Render Paperless compose file
      ansible.builtin.template:
        src: docker-compose.yml.j2
        dest: "{{ paperless_stack_dir }}/{{ paperless_stack_compose_filename }}"
        owner: root
        group: root
        mode: "0644"

    - name: AI bootstrap | Ensure AI env files exist for compose parsing
      ansible.builtin.copy:
        content: ""
        dest: "{{ paperless_stack_dir }}/{{ item }}"
        force: false
        owner: root
        group: root
        mode: "0600"
      loop:
        - "paperless-ai/.env"
        - "paperless-gpt/.env"
      when: paperless_stack_enable_ai

    - name: Deploy Paperless compose project
      community.docker.docker_compose_v2:
        project_src: "{{ paperless_stack_dir }}"
        project_name: "{{ paperless_stack_project_name }}"
        files:
          - "{{ paperless_stack_compose_filename }}"
        state: present
        pull: "{{ paperless_stack_compose_pull }}"
      when: not paperless_stack_enable_ai

    - name: AI bootstrap | Start core services only
      community.docker.docker_compose_v2:
        project_src: "{{ paperless_stack_dir }}"
        project_name: "{{ paperless_stack_project_name }}"
        files:
          - "{{ paperless_stack_compose_filename }}"
        services:
          - postgres
          - redis
          - gotenberg
          - tika
          - paperless
        state: present
        pull: "{{ paperless_stack_compose_pull }}"
      when: paperless_stack_enable_ai

    - name: Wait for Paperless web UI to become reachable
      ansible.builtin.uri:
        url: "{{ paperless_stack_bootstrap_url }}"
        method: GET
        status_code: 200
      register: paperless_stack_ui_check
      retries: "{{ paperless_stack_wait_retries }}"
      delay: "{{ paperless_stack_wait_delay }}"
      until: paperless_stack_ui_check.status == 200
      when: paperless_stack_wait_for_paperless

    - name: AI bootstrap | Request Paperless API token
      ansible.builtin.uri:
        url: "{{ paperless_stack_bootstrap_url }}/api/token/"
        method: POST
        body_format: json
        body:
          username: "{{ paperless_stack_admin_user }}"
          password: "{{ paperless_stack_admin_password }}"
        status_code: 200
      register: paperless_stack_api_login
      retries: "{{ paperless_stack_wait_retries }}"
      delay: "{{ paperless_stack_wait_delay }}"
      until:
        - paperless_stack_api_login.status == 200
        - >-
          (
            paperless_stack_api_login.json.token is defined and
            (paperless_stack_api_login.json.token | length > 0)
          ) or (
            paperless_stack_api_login.json.key is defined and
            (paperless_stack_api_login.json.key | length > 0)
          )
      no_log: true
      when: paperless_stack_enable_ai

    - name: AI bootstrap | Store runtime API token fact
      ansible.builtin.set_fact:
        paperless_stack_runtime_api_token: >-
          {{
            paperless_stack_api_login.json.token
            | default(paperless_stack_api_login.json.key | default(''))
          }}
      no_log: true
      when: paperless_stack_enable_ai

    - name: AI bootstrap | Stop stack after token bootstrap
      community.docker.docker_compose_v2:
        project_src: "{{ paperless_stack_dir }}"
        project_name: "{{ paperless_stack_project_name }}"
        files:
          - "{{ paperless_stack_compose_filename }}"
        state: absent
        remove_orphans: true
      when: paperless_stack_enable_ai

    - name: AI bootstrap | Render AI environment files with runtime token
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ paperless_stack_dir }}/{{ item.dest }}"
        owner: root
        group: root
        mode: "0640"
      loop:
        - { src: "paperless-ai.env.j2", dest: "paperless-ai/.env" }
        - { src: "paperless-gpt.env.j2", dest: "paperless-gpt/.env" }
      vars:
        paperless_stack_api_token_effective: "{{ paperless_stack_runtime_api_token }}"
      no_log: true
      when: paperless_stack_enable_ai

    - name: AI bootstrap | Bring up full stack
      community.docker.docker_compose_v2:
        project_src: "{{ paperless_stack_dir }}"
        project_name: "{{ paperless_stack_project_name }}"
        files:
          - "{{ paperless_stack_compose_filename }}"
        state: present
        pull: "{{ paperless_stack_compose_pull }}"
      when: paperless_stack_enable_ai

    - name: Wait for Paperless web UI after full stack deploy
      ansible.builtin.uri:
        url: "{{ paperless_stack_bootstrap_url }}"
        method: GET
        status_code: 200
      register: paperless_stack_ui_check_full
      retries: "{{ paperless_stack_wait_retries }}"
      delay: "{{ paperless_stack_wait_delay }}"
      until: paperless_stack_ui_check_full.status == 200
      when:
        - paperless_stack_wait_for_paperless
        - paperless_stack_enable_ai
