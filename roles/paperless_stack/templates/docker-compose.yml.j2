services:
  paperless:
    image: "{{ paperless_stack_paperless_image }}"
    container_name: paperless-ngx
    restart: "{{ paperless_stack_restart_policy }}"
    env_file:
      - ./paperless/.env
    depends_on:
      - postgres
      - redis
      - gotenberg
      - tika
    ports:
      - "{{ paperless_stack_paperless_port }}:8000"
    volumes:
      - ./paperless/data:/usr/src/paperless/data
      - ./paperless/media:/usr/src/paperless/media
      - ./paperless/export:/usr/src/paperless/export
      - ./paperless/consume:/usr/src/paperless/consume
    networks:
      - core
      - proxy

  postgres:
    image: "{{ paperless_stack_postgres_image }}"
    container_name: postgres
    restart: "{{ paperless_stack_restart_policy }}"
    env_file:
      - ./postgres/.env
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    networks:
      - core

  redis:
    image: "{{ paperless_stack_redis_image }}"
    container_name: redis
    restart: "{{ paperless_stack_restart_policy }}"
    env_file:
      - ./redis/.env
    volumes:
      - ./redis/data:/data
    networks:
      - core

  gotenberg:
    image: "{{ paperless_stack_gotenberg_image }}"
    container_name: gotenberg
    restart: "{{ paperless_stack_restart_policy }}"
    env_file:
      - ./gotenberg.env
    command:
      - "gotenberg"
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"
    networks:
      - core

  tika:
    image: "{{ paperless_stack_tika_image }}"
    container_name: tika
    restart: "{{ paperless_stack_restart_policy }}"
    env_file:
      - ./tika.env
    networks:
      - core

{% if paperless_stack_enable_ai %}
  paperless-ai:
    image: "{{ paperless_stack_paperless_ai_image }}"
    container_name: paperless-ai
    restart: "{{ paperless_stack_restart_policy }}"
    depends_on:
      - paperless
    env_file:
      - ./paperless-ai/.env
    ports:
      - "{{ paperless_stack_paperless_ai_port }}:3000"
    volumes:
      - ./paperless-ai/data:/app/data
    networks:
      - core
      - proxy

  paperless-gpt:
    image: "{{ paperless_stack_paperless_gpt_image }}"
    container_name: paperless-gpt
    restart: "{{ paperless_stack_restart_policy }}"
    depends_on:
      - paperless
    env_file:
      - ./paperless-gpt/.env
    ports:
      - "{{ paperless_stack_paperless_gpt_port }}:8080"
    volumes:
      - ./paperless-gpt/prompts:/app/prompts
    networks:
      - core
      - proxy
{% endif %}

networks:
  core:
    external: true
  proxy:
    external: true
